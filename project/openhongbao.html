<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta charset="UTF-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>传音祝福红包</title>
    <style>
        .flex{
            display: flex;
            align-items: center;
        }
        .flex_grow_1{
            flex-grow:1;
        }
        html,body {
            padding:0;
            margin:0;
            height:100%;
            background:#CA3933;
            /* background: url('img/open_hb_bg.png') no-repeat #CA3933; */
            /* background-size:100%; */
            font-family: STZhongsong ,kaiTi;
        }
        .top_font{
            font-size:0.54rem;
            font-weight:800;
            color:rgba(255,218,123,1);
        }
        .center_font{
            font-size:0.61rem;
            font-weight:bold;
            color:#32291e;
            text-align:center;
            padding-top:1.3rem;
            font-family:PingFang SC;
        }
        .left_font,.right_font{
            width:0.53rem;
            font-size:0.56rem;
            font-weight:bold;
            color:#32291e;
            line-height:1.2;
            opacity:0.9;
            font-family:PingFang SC;
        }
        .left_font{
            left: 0.56rem;
        }
        .right_font{
            right: .56rem;
        }
        .inner_top{
            text-align:center;
            color: #FBD874;
            font-size:.28rem;
            letter-spacing: 0.02rem;
            position:relative;
            top:-.5rem;
            font-weight:bold;
        }
        .qiang_btn{
            padding-top: .2rem;
            width:100%;
            text-align:center;
        }
        .listen{
            text-align:center;
            padding-left:2.33rem;
            font-size:0.4rem;
            font-weight:800;
            color:#FFDA7B;
            line-height:0.5rem;
            text-shadow:0rem 0rem .1rem rgba(125,4,5,0.8);
            font-weight:bold;

            /* background:linear-gradient(-8deg,rgba(208,163,99,1) 0%, rgba(246,232,176,1) 58.056640625%, rgba(206,159,95,1) 100%); */
            /* -webkit-background-clip:text; */
            /* -webkit-text-fill-color:transparent; */
        }
        .qiang_click_btn{
            background:url(img/qiang.png);
            width:1.5rem;
            border-radius: 50%;
            height: 1.5rem;
            background-size: 100%;
            padding: 0;
            outline: none;
            border: none;
            cursor: pointer;
        }
        .voice_box{
            top:9.7rem;
            width:100%;
            text-align:center;
            margin-top:-.01rem;
        }
        .voice_btn{
            background:url(img/voice_bg.png);
            width:3.34rem;
            /* border-radius: 50%; */
            height: .8rem;
            background-size: 100% 100%;
            padding: 0;
            outline: none;
            border: none;
            cursor: pointer;
            display: flex;
            margin:0 auto;
            padding:.0  .2rem  .07rem;
            align-items: center;
            margin-top:.05rem;
        }
        .listen_long{
            color:#D40000;
            font-size:0.26rem;
            font-weight:bold;
        }
        .btn_bg{
            background:url(img/btn_bg.png);
            width:1.64rem;
            height: .5rem;
            background-size: 100% 100%;
            padding: 0;
            outline: none;
            border: none;
            cursor: pointer;
            font-size:0.24rem;
            font-weight:800;
            color:rgba(211,0,0,1);
        }
        #box{
            /* display:none; */
            background: url('img/open_hb_bg.png')  no-repeat #CA3933;
            background-size: 100% ;
            padding-bottom:.2rem;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            z-index: 1040;
            background-color: #000;
            opacity:0;
            display:none;
        }
        .modal-backdrop.fade{
            opacity:.8;
            display:block;
        }
        .modal {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            z-index: 1050;
            display: none;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
            outline: 0;
        }
        .modal.in{
            opacity: 1;
            display: block;
        }
        .modal-dialog {
            position: relative;
            width:auto;
            margin: 10px;
            margin-top:1.2rem;

        }
        .modal-content {
            position: relative;
            text-align:center;
        }
        .modal_box{
            width:6.8rem;
            background:url(img/open/bg.png);
            background-size:100% 100%;
            /* height:3.3rem; */
            margin:0 auto;
            text-align: center;
            padding-top: 3.5rem;
            padding-bottom:.65rem;
            color:#FFD694;
        }
        .modal_btn{
            background-color:transparent;
            background:url(img/open/btn.png);
            background-size:100% 100%;
            border:none;
            outline:none;
            width:4.6rem;
            height:.7rem;
            color:#D01B33;
            font-size:0.36rem;
            font-family:PingFang SC;
            font-weight:bold;
        }
        .close_btn{
            background-color:transparent;
            background:url(img/open/close.png);
            background-size:100% 100%;
            border:none;
            outline:none;
            width:.6rem;
            height:.6rem;
            margin:0 auto;
            margin-top:.5rem;
        }
        .gongxi{
            font-size:0.4rem;
            font-family:PingFang SC;
            font-weight:bold;
            padding-bottom:.1rem;
        }
        .qiangdao{
            font-size:0.56rem;
            font-family:Microsoft YaHei;
            font-weight:bold;
            padding-bottom:.5rem;
        }
        .text_center{
            text-align:center;
        }
        .is_hit_show{
            display:none;
            color:#fff;
            font-size:.24rem;
        }
        .is_hit_show.active{
            display:block;
        }
    </style>
    <script src="js/jquery-1.11.3.js"></script>
    <script src="js/md5.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script>
    <script src="js/layer-v3.1.1/layer/layer.js"></script>
    <script>
            //引入该flexible.min.js
    !function(e,t){function n(){var n=l.getBoundingClientRect().width;t=t||540,n>t&&(n=t);var i=100*n/e;r.innerHTML="html{font-size:"+i+"px;}"}var i,d=document,o=window,l=d.documentElement,r=document.createElement("style");if(l.firstElementChild)l.firstElementChild.appendChild(r);else{var a=d.createElement("div");a.appendChild(r),d.write(a.innerHTML),a=null}n(),o.addEventListener("resize",function(){clearTimeout(i),i=setTimeout(n,300)},!1),o.addEventListener("pageshow",function(e){e.persisted&&(clearTimeout(i),i=setTimeout(n,300))},!1),"complete"===d.readyState?d.body.style.fontSize="16px":d.addEventListener("DOMContentLoaded",function(e){d.body.style.fontSize="16px"},!1)}(750,750);
    </script>
    <script>
        var search = location.search;
        var arr = search.slice(1).split('&');
        var arr2 = [];
        for(var i=0;i<arr.length;i++){
            var o = arr[i];
            var c = o.indexOf('=')
            if(c>0){
                arr2[o.slice(0,c)] = o.slice(c+1)
            }
        }
        if(localStorage['openid']){

        }else{

        }
    </script>
</head>
<body>
    <div id="share_tip" style="display:none;">
        <img src="img/open/share.png" alt="" style="width:100%;">
    </div>
    <div id="box">
        <!-- <img src="img/open_hb_bg.png" alt="" style="width:100%;"> -->
        <div style="padding-top:.2rem;">
            <div class="flex">
                <div style="padding:.05rem;width:.82rem;height:0.82rem;background:url(img/circle_bg.png);background-size:100% 100%;margin:0 .2rem 0 .3rem;">
                    <img class="head_img" src="" alt="" style="width:.82rem;border-radius:50%;">
                </div>
                <div class="top_font" id="zhufutitle">
                    祝您2020年幸福安康
                </div>
            </div>
        </div>
        <div class="center_font" id="hengfu">
            万事如意
        </div>
        <div class="flex" style="padding:1.1rem .56rem 0;">
            <div class="left_font" id="shanglian">
                年年如意发大财
            </div>
            <div class="inner_top flex_grow_1">
                <div style="font-size:.38rem">
                    <span id="hongbao" style="font-size:.5rem"></span>元红包
                </div>
                <div>点击抢红包 带祝福回家</div>
                <div class="qiang_btn">
                    <button id="hbid" class="qiang_click_btn" type="button" data_id=""></button>
                    <!-- <img src="img/qiang.png" alt="" style="width: 2rem;"> -->
                </div>
            </div>
            <div class="right_font" id="xialian">
                岁岁平安行大运
            </div>
        </div>
        
        <div class="voice_box">
            <div class="listen flex">
                听听
                <div style="padding:.04rem;width:.5rem;height:.5rem;background:url(img/listen_img.png);background-size:100% 100%;">
                    <img class="head_img" src="" alt="" style="width:.5rem;border-radius:50%;">
                </div>
                的祝福
            </div>
            <button type="button" class="voice_btn" id="serverid" data_id="">
                <img src="img/start.png" alt="" style="width:.42rem;height:.42rem;">
                <img src="img/voice.png" alt="" style="width:60%;margin-left:.1rem;">
                <span class="listen_long flex_grow_1" style="text-align:right;padding-right:.1rem;" id="voicetime"></span>
            </button>
            <div class="flex">
                <div class="flex_grow_1" style="text-align:right;">
                    <button class="btn_bg" type="button" id="go_loadhongbao">我也发祝福</button>
                </div>
                <button class="btn_bg" type="button"  id="go_lucky" style="margin:0 .16rem;">大家手气</button>
                <div class="flex_grow_1" style="text-align:left;">
                    <button class="btn_bg" id="go_hongbaolist" type="button">抢红包记录</button>
                </div>
            </div>
            <div class="flex" style="padding:0.1rem 0 0 1.8rem;text-align:left;color:rgba(255,218,123,1);font-weight:bold;">
                <div>
                    <span style="font-size:.32rem;">可提现红包：<span id="myhongbao"></span>元</span>
                    <div style="font-size:.26rem;">扫码关注公众号管理红包</div>
                </div>
                <div style="background-image: url(img/open/kh.png);background-size:100% 100%;padding:.1rem .2rem 0;margin-left:.26rem;">
                    <img class="gongzhonghao" src="img/qrcode_ex.png" alt="" style="width:.98rem;">
                </div>
                    
            </div>
        </div>
        <div class="modal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal_box">
                        
                        <div class="qiangdao active">
                            <div class="gongxi">恭喜你</div>
                            <div class="hit_desc">抢到红包</div>
                            <div class="is_hit_show">抢到*.88元红包发抢双方皆奖100元</div>
                        </div>
                        <button class="modal_btn" type="button">红包去哪了？</button>
                        <div class="qiangdao_0 active" style="padding:.1rem 1.1rem 0;font-size: 0.28rem;font-family: PingFang SC;font-weight: bold;">
                            <div class="flex" style="justify-content: space-between;">
                                <span class="tipdown" style="text-align: left;"></span> 
                                <img class="gongzhonghao" src="img/qrcode_ex.png" alt="" style="width:.88rem;margin-left:.1rem;">
                       
                            </div>
                        </div> 
                    </div>
                    <button type="button" class="close_btn"></button>
                </div>
            </div>
        </div>
        <div class="modal-backdrop"></div>
    </div>

    <script>
        $(function(){
            var src = '';
            var isstart = false;
            var voicetime = 0;
            var voice = {
                localId: '',
                serverId: ''
            };
            var status = 0;
            let device ;
            let u = navigator.userAgent, app = navigator.appVersion;
            let isAndroid = u.indexOf('Android') > -1 || u.indexOf('Linux') > -1; //g
            let isIOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
            if (isAndroid) {
                device = 0
            }
            if (isIOS) {
                device = 1
            }
            let pid = '';
            let hbid = '';
            if(arr2['pid']){
                pid = arr2['pid']
            }
            if(arr2['hbid']){
                hbid = arr2['hbid']
            }
            let state = decodeURIComponent(arr2['state']).split(',')
            if(arr2['code'] && state.length>1){
                pid = state[0];
                hbid = state[1];
            }

            $('#hbid').click(function(){
                if(localStorage.getItem('openid')){

                }else{
                    location.href = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx13665daee96a688b&redirect_uri=http%3A%2F%2Fwww.baozhufu.com%2Fbaozhufu%2Fopenhongbao.html&response_type=code&scope=snsapi_userinfo&state='+pid+','+hbid+'#wechat_redirect'
                    return;
                }
                let id = $(this).attr('data_id');
                if(id){
                    let now = new Date();
                    let md5_data = md5('token=' + now.getTime() + '&key=lldu43d98382');
                    let obj = {
                        token:now.getTime(),
                        data:md5_data,
                        hbid:id,
                    }
                    if(localStorage.getItem('openid')){
                        obj.openid = localStorage.getItem('openid');
                    }
                    $.ajax({
                        url:'qianghongbao.php',
                        type:'POST',
                        data: obj,
                        success:function(json){
                            var data = JSON.parse(json)
                            if(data.errorcode == 0){
                                if(data.ishit==1){
                                    $('.gongxi').html('恭喜你')
                                    $('.is_hit_show').addClass('active')
                                }else{
                                    $('.gongxi').html('抱歉')
                                    $('.is_hit_show').removeClass('active')
                                }
                                $('.hit_desc').html(data.content)
                                $('.tipdown').html(data.tipdown)
                                $('#myhongbao').html(data.hongbao)
                                $('.modal-backdrop').addClass('fade');
                                $('.modal').addClass('in');
                            }else{
                                if(data.message){
                                    $('.gongxi').html(data.message)
                                }else{
                                    $('.gongxi').html('')
                                }
                                $('.hit_desc').html(data.content)
                                $('.modal-backdrop').addClass('fade');
                                $('.modal').addClass('in');
                            }
                        }
                    })
                }
            })
            
            $('.close_btn').click(function(){
                $('.modal-backdrop').removeClass('fade');
                $('.modal').removeClass('in');
                // if($(this).attr('data_ishit')==1){
                //     layer.alert('<div class="text_center"><div class="tipup">'+$(this).attr('data_tipup')+'</div> <img src="'+src+'" style="width:.6rem;"/> <div class="tipdown">'+$(this).attr('data_tipdown')+'</div></div>');
                // }
            })
            $('.modal_btn').click(function(){
                location.href = 'hongbaolist.html'
            })
       
            $('#go_loadhongbao').click(function(){
                if(localStorage.getItem('openid')){

                }else{
                    location.href = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx13665daee96a688b&redirect_uri=http%3A%2F%2Fwww.baozhufu.com%2Fbaozhufu%2Fopenhongbao.html&response_type=code&scope=snsapi_userinfo&state='+pid+','+hbid+'#wechat_redirect'
                    return;
                }
                location.href = 'loadhongbao.html'
            })
            $('#go_lucky').click(function(){
                if(localStorage.getItem('openid')){

                }else{
                    location.href = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx13665daee96a688b&redirect_uri=http%3A%2F%2Fwww.baozhufu.com%2Fbaozhufu%2Fopenhongbao.html&response_type=code&scope=snsapi_userinfo&state='+pid+','+hbid+'#wechat_redirect'
                    return;
                }
                location.href = 'lucky.html?hbid='+$('#hbid').attr('data_id')
            })
            $('#go_hongbaolist').click(function(){
                if(localStorage.getItem('openid')){

                }else{
                    location.href = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx13665daee96a688b&redirect_uri=http%3A%2F%2Fwww.baozhufu.com%2Fbaozhufu%2Fopenhongbao.html&response_type=code&scope=snsapi_userinfo&state='+pid+','+hbid+'#wechat_redirect'
                    return;
                }
                location.href = 'hongbaolist.html'
            })
            var link = location.href;
            var title= '';
            var desc= '';

            let now = new Date();
            let md5_data = md5('token=' + now.getTime() + '&key=lldu43d98382');
            let obj = {
                device:device,
                pid:pid,
                hbid:hbid,
                token:now.getTime(),
                data:md5_data
            }
            if(localStorage.getItem('openid')){
                obj.openid = localStorage.getItem('openid');
            }
            if(arr2['code']){
                obj.code = arr2['code']
            }
            $.ajax({
                url:'gethongbaodata.php',
                type:'POST',
                data:obj,
                success:function(json){
                    var data = JSON.parse(json)
                    if(data.errorcode == 0){
                        $('.head_img').attr('src',data.headimg);
                        $('.gongzhonghao').attr('src',data.gongzhonghao);
                        $('#myhongbao').html(data.myhongbao);
                        $('#hongbao').html(data.hongbao);
                        $('#hbid').attr('data_id',data.hbid);
                        $('#zhufutitle').html(data.zhufutitle);
                        $('#hengfu').html(data.hengfu);
                        $('#shanglian').html(data.shanglian);
                        $('#xialian').html(data.xialian);
                        $('#voicetime').html(data.voicetime+'s');
                        voicetime = parseFloat(data.voicetime)*1000;
                        src = data.gongzhonghao;
                        link = data.link;
                        title = data.title;
                        desc = data.desc;

                        // if(data.uid){
                        //     localStorage.setItem('uid',data.uid);
                        // }
                        if(data.uid == arr2['pid']){
                            $('#share_tip').css({display:'block'})
                        }else{
                            $('#share_tip').css({display:'none'})
                        }
                        
                        if(data.serverid){
                            voice.serverId = data.serverid;
                            // 获取JS-API配置项数据getjsapiconfig.php 
                            let now_1 = new Date();
                            let md5_data_1 = md5('token=' + now_1.getTime() + '&key=lldu43d98382');
                            $.ajax({
                                url:'getjsapiconfig.php',
                                type:'POST',
                                data:{token:now_1.getTime(),data:md5_data_1,url:location.href},
                                success:function(set){
                                    var data = JSON.parse(set);
                                    if(data.errorcode == 0){
                                        wx.config({
                                            debug: false,
                                            appId: data.appid, // 必填，getjsapiconfig.php返回
                                            timestamp: data.timestamp, // 必填，getjsapiconfig.php返回
                                            nonceStr: data.noncestr, // 必填，getjsapiconfig.php返回
                                            signature: data.signature,// 必填getjsapiconfig.php返回
                                            jsApiList: [
                                                // 所有要调用的 API 都要加到这个列表中
                                                'playVoice',
                                                'stopVoice',
                                                'downloadVoice',
                                                'onVoicePlayEnd',
                                                'updateAppMessageShareData',  //分享给朋友
                                                'updateTimelineShareData', //分享朋友圈
                                            ]
                                        });

                                        wx.ready(function () {
                                            //分享给朋友
                                            //需在用户可能点击分享按钮前就先调用
                                            wx.updateAppMessageShareData({ 
                                                title: title , // 分享标题
                                                desc: desc, // 分享描述
                                                link: link, // 分享链接，getsharedata.php 的link字段
                                                imgUrl: 'http://www.baozhufu.com/baozhufu/hbicon.jpg', // 分享图标
                                                success: function () {
                                                    // layer.msg('分享成功~')
                                                }
                                            })
                                            wx.updateTimelineShareData({ 
                                                title: title, // 分享标题
                                                link: link, // 分享链接，该getsharedata.php 的link字段
                                                imgUrl: 'http://www.baozhufu.com/baozhufu/hbicon.jpg', // 分享图标
                                                success: function () {
                                                    // layer.msg('分享朋友圈成功~')
                                                }
                                            })
                                            wx.downloadVoice({
                                                serverId: voice.serverId, // 需要下载的音频的服务器端ID，由uploadVoice接口获得
                                                isShowProgressTips: 1, // 默认为1，显示进度提示
                                                success: function (res) {
                                                    var localId = res.localId; // 返回音频的本地ID
                                                    $('#serverid').attr('data_id',res.localId);
                                                    voice.localId = res.localId;
                                                    if (voice.localId) {
                                                        wx.playVoice({
                                                            localId: voice.localId,
                                                            success:function(){
                                                                isstart = true;
                                                            }
                                                        });
                                                    }
                                                                
                                                    $('#serverid').click(function(){
                                                        let id = $(this).attr('data_id');
                                                        if(id){
                                                            if(isstart){
                                                                wx.stopVoice({
                                                                    localId: voice.localId,
                                                                    success:function(){
                                                                        isstart = false;
                                                                    }
                                                                });
                                                            }else{
                                                                if (voice.localId == '') {
                                                                    layer.msg('请先录制一段声音');
                                                                    return;
                                                                }
                                                                wx.playVoice({
                                                                    localId: voice.localId,
                                                                    success:function(){
                                                                        isstart = true;
                                                                    }
                                                                });
                                                            }
                                                        }
                                                    })
                                                    wx.onVoicePlayEnd({
                                                        complete: function (res) {
                                                            isstart = false;
                                                        }
                                                    });

                                                },
                                                fail:function(res){
                                                    layer.msg(JSON.stringify(res))
                                                }
                                            });
                                        })
                                    }
                                    if(data.message){
                                        layer.msg(data.message);
                                    }
                                }

                            })
                            
                        }
                        $('#box').css('display','block');
                        if(data.openid){
                            localStorage.setItem('openid',data.openid);
                        }else{
                            location.href = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx13665daee96a688b&redirect_uri=http%3A%2F%2Fwww.baozhufu.com%2Fbaozhufu%2Fopenhongbao.html&response_type=code&scope=snsapi_userinfo&state='+pid+','+hbid+'#wechat_redirect'
                        }
                    }else{
                        if(data.message){
                            $('body').html('<h3>'+data.message+'</h3>')
                            return;
                        }
                    }
                }
            })
            
            
            if(arr2['code'] || localStorage.getItem('openid')){
            }else{    
                
            }
        })
    </script>
    
    
</body>
</html>